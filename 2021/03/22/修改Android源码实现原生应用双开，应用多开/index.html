<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 修改Android源码实现原生应用双开，应用多开 · luoyesiqiu</title><meta name="description" content="修改Android源码实现原生应用双开，应用多开 - luoyesiqiu"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="http://luoyesiqiu.github.io/atom.xml" title="luoyesiqiu"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="luoyesiqiu" type="application/atom+xml">
</head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">luoyesiqiu</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>主页</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>归档</p></a><a href="/about/me" target="_self" class="li component-nav-item"><p>关于我</p></a><ul class="shortcut-icons"><a href="https://github.com/luoyesiqiu" target="_blank"><img src="/images/github.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">修改Android源码实现原生应用双开，应用多开</h1><div class="post-info">2021年3月22日</div><div class="post-content"><h1 id="1-准备"><a href="#1-准备" class="headerlink" title="1. 准备"></a>1. 准备</h1><p><img src="/images/multi-app/sample.png" alt="效果图"></p>
<p>把某系统双开的两个app的信息进行对比</p>
<h2 id="1-1-目录的对比"><a href="#1-1-目录的对比" class="headerlink" title="1.1 目录的对比"></a>1.1 目录的对比</h2><h3 id="1-1-1-data目录对比"><a href="#1-1-1-data目录对比" class="headerlink" title="1.1.1 data目录对比"></a>1.1.1 data目录对比</h3><p>原应用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;data&#x2F;user&#x2F;0&#x2F;com.luoyesiqiu.crackme&#x2F;files</span><br></pre></td></tr></table></figure>

<p>被复制的应用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;data&#x2F;user&#x2F;999&#x2F;com.luoyesiqiu.crackme&#x2F;files</span><br></pre></td></tr></table></figure>
<h3 id="1-1-2-apk所在目录对比"><a href="#1-1-2-apk所在目录对比" class="headerlink" title="1.1.2 apk所在目录对比"></a>1.1.2 apk所在目录对比</h3><p>原应用：</p>
<p><code>/data/app/com.luoyesiqiu.crackme-H1Dvbka0t42rzlCAqSpgHQ==/base.apk</code></p>
<p>被复制的应用：</p>
<p><code>/data/app/com.luoyesiqiu.crackme-H1Dvbka0t42rzlCAqSpgHQ==/base.apk</code></p>
<p>通过对比apk安装目录和数据目录，我们可以知道，该系统的双开是<strong>共用同一个apk</strong>，但是却拥有<strong>独立的数据目录</strong>。</p>
<h2 id="1-2-进程信息对比"><a href="#1-2-进程信息对比" class="headerlink" title="1.2 进程信息对比"></a>1.2 进程信息对比</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">USER           PID  PPID     VSZ    RSS WCHAN            ADDR S NAME</span><br><span class="line">u0_a161      30284   918 2276572  48420 SyS_epoll_wait      0 S com.luoyesiqiu.crackme</span><br><span class="line">u999_a161    30311   918 2276572  48004 SyS_epoll_wait      0 S com.luoyesiqiu.crackme</span><br></pre></td></tr></table></figure>

<p>通过查看进程信息，可以知道，这两个应用运行于<strong>不同的用户</strong>中。</p>
<p>为了实现和它相似的功能，我们做下文的配置。</p>
<h1 id="2-修改创建用户限制"><a href="#2-修改创建用户限制" class="headerlink" title="2. 修改创建用户限制"></a>2. 修改创建用户限制</h1><p>从Android5.0开始，Android支持创建Profile.默认情况下，系统只允许创建一个新的多开用户，也就是只能双开，但是修改源码可以达到创建多个用户。</p>
<p>修改<code>frameworks/base/services/core/java/com/android/server/pm/UserManagerService.java</code><br>的MAX_MANAGED_PROFILES字段，改成自己想要创建的最大用户数，它的默认值是1.</p>
<h1 id="3-创建用户"><a href="#3-创建用户" class="headerlink" title="3. 创建用户"></a>3. 创建用户</h1><p>创建一个用户即创建一个多开容器，调用createProfile方法，flag传入0x00000020，以创建一个用户并将它开启</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span>  <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getUserIdFromUserInfo</span><span class="params">(Object userInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> userId = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Field field_id = userInfo.getClass().getDeclaredField(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        field_id.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        userId = (Integer)field_id.get(userInfo);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startUser</span><span class="params">(<span class="keyword">int</span> userId)</span></span>&#123;</span><br><span class="line">    Object iActivityManager = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        iActivityManager = Class.forName(<span class="string">&quot;android.app.ActivityManagerNative&quot;</span>).getMethod(<span class="string">&quot;getDefault&quot;</span>).invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> isOk=(<span class="keyword">boolean</span>)iActivityManager.getClass().getMethod(<span class="string">&quot;startUserInBackground&quot;</span>,<span class="keyword">int</span>.class)</span><br><span class="line">                .invoke(iActivityManager,userId);</span><br><span class="line">        <span class="keyword">return</span> isOk;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span>  String <span class="title">createProfile</span><span class="params">(Context context, String userName, <span class="keyword">int</span> flag)</span> </span>&#123;</span><br><span class="line">    UserManager mUserManager = (UserManager) context.getSystemService(Context.USER_SERVICE);</span><br><span class="line"></span><br><span class="line">    UserHandle userHandle = UserHandle.getUserHandleForUid(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    Log.d(TAG,<span class="string">&quot;userHandle = &quot;</span>+userHandle.toString());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> getIdentifier=(<span class="keyword">int</span>)userHandle.getClass().getMethod(<span class="string">&quot;getIdentifier&quot;</span>).invoke(userHandle);</span><br><span class="line">        Log.d(TAG,<span class="string">&quot;Identifier = &quot;</span>+getIdentifier);</span><br><span class="line">        mUserInfo=mUserManager.getClass().getMethod(<span class="string">&quot;createProfileForUser&quot;</span>,String.class, <span class="keyword">int</span>.class, <span class="keyword">int</span>.class)</span><br><span class="line">                .invoke(mUserManager</span><br><span class="line">                        ,userName</span><br><span class="line">                        , flag</span><br><span class="line">                        ,getIdentifier);</span><br><span class="line">        <span class="keyword">if</span>(mUserInfo==<span class="keyword">null</span>)&#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;mUserInfo is null!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> userId = getUserIdFromUserInfo(mUserInfo);</span><br><span class="line">        <span class="keyword">boolean</span> isOk=startUser(userId);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;startUserInBackground() userId = &quot;</span> + userId + <span class="string">&quot; | isOk = &quot;</span> + isOk);</span><br><span class="line">        <span class="keyword">return</span> isOk ? <span class="string">&quot;&quot;</span>+userId : <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：创建用户的App要在AndroidManifest.xml的manifest节点下加入<code>android:sharedUserId=&quot;android.uid.system&quot;</code>字段，加入<code>&lt;uses-permission android:name=&quot;android.permission.MANAGE_USERS&quot;/&gt;</code>权限，还要使用系统的platform签名对apk进行签名。</p>
</blockquote>
<p>上面的方法似乎有点麻烦，其实创建多开用户还有更简单的办法，只需要一条命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pm create-user --profileOf 0 --managed myspace</span><br></pre></td></tr></table></figure>

<ul>
<li>profileOf 指定父用户id,0即系统用户</li>
<li>managed 指定创建的用户为多开用户</li>
<li>myspace 为用户名</li>
</ul>
<h1 id="4-配置系统应用不安装到子用户"><a href="#4-配置系统应用不安装到子用户" class="headerlink" title="4. 配置系统应用不安装到子用户"></a>4. 配置系统应用不安装到子用户</h1><p>默认情况下，在创建一个新用户的时候，系统会给新用户复制一份系统应用，但是在子用户中我们并不需要系统应用，所以我们要在子用户中取消安装这些系统应用。</p>
<blockquote>
<p>注：系统应用可以不安装到子用户，但是系统服务一定要安装到子用户，否则，运行在子用户的app可能无法正常运行。</p>
</blockquote>
<p>修改frameworks/base/services/core/java/com/android/server/pm/Settings.java</p>
<p>createNewUserLI方法，对系统应用和系统服务是否安装到子用户进行配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String[] excludeLiStrings=&#123;</span><br><span class="line">    <span class="string">&quot;android&quot;</span>,</span><br><span class="line">    <span class="string">&quot;android.ext.services&quot;</span>,</span><br><span class="line">    <span class="string">&quot;android.ext.shared&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.bluetooth&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.htmlviewer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.inputdevices&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.shell&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.certinstaller&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.externalstorage&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.providers.contacts&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.providers.downloads&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.providers.media&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.providers.settings&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.providers.userdictionary&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.server.telecom&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.packageinstaller&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.settings&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.providers.telephony&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.mms.service&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.webview&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.location.fused&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.cts.priv.ctsshim&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.statementservice&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.defcontainer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.keychain&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.proxyhandler&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.dreams.basic&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.printspooler&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.pacprocessor&quot;</span>,</span><br><span class="line">    <span class="string">&quot;com.android.providers.downloads.ui&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isInExcludeList</span><span class="params">(String pkg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(String excludePkg:excludeLiStrings)&#123;</span><br><span class="line">        <span class="keyword">if</span>(excludePkg.equals(pkg))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createNewUserLI</span><span class="params">(<span class="meta">@NonNull</span> PackageManagerService service, <span class="meta">@NonNull</span> Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> userHandle)</span> </span>&#123;</span><br><span class="line">    String[] volumeUuids;</span><br><span class="line">    String[] names;</span><br><span class="line">    <span class="keyword">int</span>[] appIds;</span><br><span class="line">    String[] seinfos;</span><br><span class="line">    <span class="keyword">int</span>[] targetSdkVersions;</span><br><span class="line">    <span class="keyword">int</span> packagesCount;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        Collection&lt;PackageSetting&gt; packages = mPackages.values();</span><br><span class="line">        packagesCount = packages.size();</span><br><span class="line">        volumeUuids = <span class="keyword">new</span> String[packagesCount];</span><br><span class="line">        names = <span class="keyword">new</span> String[packagesCount];</span><br><span class="line">        appIds = <span class="keyword">new</span> <span class="keyword">int</span>[packagesCount];</span><br><span class="line">        seinfos = <span class="keyword">new</span> String[packagesCount];</span><br><span class="line">        targetSdkVersions = <span class="keyword">new</span> <span class="keyword">int</span>[packagesCount];</span><br><span class="line">        Iterator&lt;PackageSetting&gt; packagesIterator = packages.iterator();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; packagesCount; i++) &#123;</span><br><span class="line">            PackageSetting ps = packagesIterator.next();</span><br><span class="line">            <span class="keyword">if</span> (ps.pkg == <span class="keyword">null</span> || ps.pkg.applicationInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Only system apps are initially installed.</span></span><br><span class="line">            <span class="comment">//Slog.w(TAG, &quot;User handle:&quot;+userHandle+&quot;,pkg name:&quot;+ps.name);</span></span><br><span class="line">            <span class="comment">//修改的地方，在列表外的应用不安装到子用户</span></span><br><span class="line">            <span class="keyword">if</span>(userHandle &gt; <span class="number">0</span> &amp;&amp; !isInExcludeList(ps.name))&#123;</span><br><span class="line">                ps.setInstalled(<span class="keyword">false</span>, userHandle);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                 ps.setInstalled(ps.isSystem(), userHandle);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Need to create a data directory for all apps under this user. Accumulate all</span></span><br><span class="line">            <span class="comment">// required args and call the installer after mPackages lock has been released</span></span><br><span class="line">            volumeUuids[i] = ps.volumeUuid;</span><br><span class="line">            names[i] = ps.name;</span><br><span class="line">            appIds[i] = ps.appId;</span><br><span class="line">            seinfos[i] = ps.pkg.applicationInfo.seinfo;</span><br><span class="line">            targetSdkVersions[i] = ps.pkg.applicationInfo.targetSdkVersion;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; packagesCount; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (names[i] == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> triage flags!</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags = StorageManager.FLAG_STORAGE_CE | StorageManager.FLAG_STORAGE_DE;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            installer.createAppData(volumeUuids[i], names[i], userHandle, flags, appIds[i],</span><br><span class="line">                    seinfos[i], targetSdkVersions[i]);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Failed to prepare app data&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        applyDefaultPreferredAppsLPw(service, userHandle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="5-给非系统用户安装和卸载软件"><a href="#5-给非系统用户安装和卸载软件" class="headerlink" title="5. 给非系统用户安装和卸载软件"></a>5. 给非系统用户安装和卸载软件</h1><ol>
<li>安装app到指定用户</li>
</ol>
<p><code>pm install -t -r --user &lt;userId&gt; &lt;apkPath&gt;</code></p>
<ul>
<li><p>-r 替换存在的</p>
</li>
<li><p>–user 指定安装到的用户</p>
</li>
</ul>
<blockquote>
<p>注：安装app后要重启默认启动器（Launcher），不然可能会出现奇怪的问题</p>
</blockquote>
<ol start="2">
<li>从指定用户卸载app</li>
</ol>
<p><code>pm uninstall --user &lt;userId&gt; &lt;pkgName&gt;</code></p>
<h1 id="6-设置App默认只安装到主用户"><a href="#6-设置App默认只安装到主用户" class="headerlink" title="6. 设置App默认只安装到主用户"></a>6. 设置App默认只安装到主用户</h1><p>开启子用户后，如果调用<code>adb install</code>或者<code>pm install</code>来安装apk,会把apk安装所有用户。这不是我们想要的，所以，我们修改成执行这些命令时，只把app安装到主用户。</p>
<p>第一步：针对用pm install命令安装apk的方式</p>
<p>frameworks/base/cmds/pm/src/com/android/commands/pm/Pm.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InstallParams</span> </span>&#123;</span><br><span class="line">    SessionParams sessionParams;</span><br><span class="line">    String installerPackageName;</span><br><span class="line">    <span class="comment">//int userId = UserHandle.USER_ALL;</span></span><br><span class="line">    <span class="keyword">int</span> userId = UserHandle.USER_SYSTEM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二步：针对用adb install命令安装apk的方式</p>
<p>在旧版本系统上，<code>adb install</code>会调用<code>pm install</code>来安装apk,但在新版的系统上会调用<code>cmd package</code>命令来安装apk。</p>
<p><code>package</code>命令的具体实现在：</p>
<p>frameworks/base/services/core/java/com/android/server/pm/PackageManagerShellCommand.java</p>
<p>所以，修改以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InstallParams</span> </span>&#123;</span><br><span class="line">    SessionParams sessionParams;</span><br><span class="line">    String installerPackageName;</span><br><span class="line">    <span class="comment">//int userId = UserHandle.USER_ALL;</span></span><br><span class="line">    <span class="keyword">int</span> userId = UserHandle.USER_SYSTEM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="7-删除用户"><a href="#7-删除用户" class="headerlink" title="7. 删除用户"></a>7. 删除用户</h1><p><code>adb shell pm remove-user &lt;userId&gt;</code></p>
<p>或者调用以下代码删除</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">deleteUser</span><span class="params">(Context context,<span class="keyword">int</span> userId)</span></span>&#123;</span><br><span class="line">    UserManager userManager=(UserManager) context.getSystemService(Context.USER_SERVICE);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        userManager.getClass().getMethod(<span class="string">&quot;removeUser&quot;</span>,<span class="keyword">int</span>.class).invoke(userManager,userId);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="8-修改用户App右下角标"><a href="#8-修改用户App右下角标" class="headerlink" title="8. 修改用户App右下角标"></a>8. 修改用户App右下角标</h1><p>开启多用户后，如果给多个子用户安装相同的App，它们会显示相同的右下小图标(在源码中被叫做Badge)，让我们难以辨别，我们可以让不同的用户显示不同的右下小图标，数字图标就是不错的选择，我们来看看如何修改</p>
<p><code>frameworks/base/core/java/android/app/ApplicationPackageManager.java</code>的getBadgeResIdForUser方法，返回一个Drawable资源id，作为子用户App的右下小图标</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getBadgeResIdForUser</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Return the framework-provided badge.</span></span><br><span class="line">    <span class="keyword">if</span> (isManagedProfile(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> com.android.internal.R.drawable.ic_corp_icon_badge;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个图标是要在右下角的，所以在做图标的时候，要做一张大的图标，它的右下角放着要显示的小图标，其余部分以透明填充。做好图标后要生成svg格式，用Android Studio以Vector Assets导入，大小64x64，导入成功会在项目的res/drawable生成drawable资源文件，把资源文件替换到<code>frameworks/base/core/res/res/drawable/ic_corp_icon_badge.xml</code>，并在<code>frameworks/base/core/res/res/values/symbols.xml</code>添加对drawable文件的声明</p>
<h1 id="9-在最新任务列表出现多开应用"><a href="#9-在最新任务列表出现多开应用" class="headerlink" title="9. 在最新任务列表出现多开应用"></a>9. 在最新任务列表出现多开应用</h1><p>默认情况下，最近任务列表是不会出现多开应用的。</p>
<p>在<code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code>的getRecentTasks方法中，有一段校验：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; recentsCount &amp;&amp; maxNum &gt; <span class="number">0</span>; i++) &#123;</span><br><span class="line">    TaskRecord tr = mRecentTasks.get(i);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">if</span> (!tr.mUserSetupComplete) &#123;</span><br><span class="line">         <span class="comment">// Don&#x27;t include task launched while user is not done setting-up.</span></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_RECENTS) Slog.d(TAG_RECENTS,</span><br><span class="line">                     <span class="string">&quot;Skipping, user setup not complete: &quot;</span> + tr);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    res.add(rti);</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以将这段校验注释掉，tr是<code>frameworks/base/services/core/java/com/android/server/am/TaskRecord.java</code>类实例，mUserSetupComplete赋值如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mUserSetupComplete = Settings.Secure.getIntForUser(mService.mContext.getContentResolver(),</span><br><span class="line">        USER_SETUP_COMPLETE, <span class="number">0</span>, userId) != <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h1 id="10-修改多开应用最近任务的名称"><a href="#10-修改多开应用最近任务的名称" class="headerlink" title="10. 修改多开应用最近任务的名称"></a>10. 修改多开应用最近任务的名称</h1><p>子用户默认会在最近任务的应用名称前加上”工作”这两个字，语言是英文会显示”Work”，如果想隐藏它们</p>
<p>中文：</p>
<p><code>frameworks/base/core/res/res/values-zh-rCN/strings.xml</code></p>
<p>英文：</p>
<p><code>frameworks/base/core/res/res/values/strings.xml</code></p>
<p>修改<code>managed_profile_label_badge</code>字段，去掉”工作”或者”Work”即可。</p>
<h1 id="11-修改卸载时的提示文本"><a href="#11-修改卸载时的提示文本" class="headerlink" title="11. 修改卸载时的提示文本"></a>11. 修改卸载时的提示文本</h1><p>如果是多开应用，卸载时提示的文本和主用户是不一样的，如果需要修改，则修改下面的文件</p>
<p>中文：</p>
<p><code>packages/apps/PackageInstaller/res/values-zh-rCN/strings.xml</code></p>
<p>英文：</p>
<p><code>packages/apps/PackageInstaller/res/values/strings.xml</code></p>
<p>修改<code>uninstall_application_text_user</code>字段的值</p>
<h1 id="12-参考"><a href="#12-参考" class="headerlink" title="12. 参考"></a>12. 参考</h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/CeoijS42tkNLejkHw0waOw">Android 多用户 —— 从入门到应用分身 (上)</a></p>
</div></article></div></div></main><footer class="footer-container"><div class="paginator"><a href="/2021/04/03/%E4%BF%AE%E5%A4%8DFART-dump%E4%B8%8B%E6%9D%A5%E7%9A%84dex/" class="prev">上一篇</a><a href="/2021/03/20/hook%20Java%20API%E4%BB%A5%E8%8E%B7%E5%BE%97MD5%E8%AE%A1%E7%AE%97%E5%89%8D%E6%95%B0%E6%8D%AE/" class="next">下一篇</a></div><div class="copyright"><p>© 2021 <a href="http://luoyesiqiu.github.io">luoyesiqiu</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer></body></html>